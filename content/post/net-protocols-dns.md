---
author: ahaooahaz
image:
urlname: "net-protocols-dns"
slug: "net-protocols-dns"
date: 2024-06-18T15:53:24+08:00
title: "网络协议之DNS协议"
tags:
  - technical
  - network
draft: true
weight: 60
---
<!--more-->
# DNS协议
DNS协议的作用是通过域名查询到对应的IP地址，DNS协议依赖UDP/TCP协议实现（UDP较多）。
## DNS协议包
DNS报文分为**请求**和**应答**两种，结构是类似的，其中头部的大小固定为12字节，其他部分大小不固定，记录数可多可少，数目保存在头部中，大致分为五部分：
- 头部（header），描述报文类型，以及其下 4 个小节的情况；
- 问题节（question），保存查询问题；
- 答案节（answer），保存问题答案，也就是查询结果；
- 授权信息节（authority），保存授权信息；
- 附加信息节（additional），保存附加信息；
```text
|<-------------------16 bits------------------->|

0                       8                       16
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+   ---
|                       ID                      |    ^              
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+    |
|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+    |
|                  QDCOUNT                      |    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+   HEADER 12 bytes
|                  ANCOUNT                      |    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+    |
|                  NSCOUNT                      |    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+    |
|                  ARCOUNT                      |    v
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+   ---
|                                               |    ^
+                                               +    |
|             |NAME|TYPE|CLASS| * N                  |   QUERY
+                                               +    |
|                                               |    v
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+   ---

```
### 请求
##### HEADER
HEADER部分的大小固定为12字节。
- `ID`: 一个16位的ID，在应答中原样返回，以此匹配请求和应答；
- 标识信息
	- `QR`: 位标记报文是一个查询请求，还是查询应答，`0`表示查询请求，`1`表示查询应答；
	- `Opcode`: 占4比特位，表示操作类型，`0`表示标准查询，`1`表示反向查询，`2`表示服务器状态请求；
	- `AA`(authoritative answer): 标识权威回答，表示当前查询结果是由域名的权威服务器返回的；
	- `TC`(truncated): 标识截断，如果查询应答超过512字节，则只返回前512字节；
	- `RD`(recursion desired): 标识期望递归，在查询请求中设置，并在查询应答中返回，为`1`时，如果服务器没有授权回答，则需要服务器替客户端请求其他DNS服务器，即*递归查询*，为`0`时，如果服务器没有授权回答，就返回一个可以处理此请求的NS服务器列表给客户端，由客户端请求其他服务器查询，即*迭代查询*；
	- `RA`(recursion available): 标识服务器是否支持递归查询；
	- `Z`: 保留比特位，暂没有使用，必须为`0`；
	- `RCODE`(response code): 占用4比特位，`0`表示正常，`3`由权威服务器返回，表示带查询域名不存在；
- QDCOUNT: 问题记录数
- ANCOUNT: 答案记录数
- NSCOUNT: 授权信息记录数
- ARCOUNT: 附加信息记录数
##### QUERY
QUERY部分的大小是不固定的，其中内容为`NAME|TYPE|CLASS`的列表，一个`NAME|TYPE|CLASS`的组合称为问题记录，条数记录在`HEADER`中，所以DNS协议支持一次查询多个域名的地址，但通常只查询一个。
问题记录由3个部分组成：
- NAME: 待查询的域名，字段长度不固定，由域名的长度决定；
- TYPE: 查询类型，
	- `1`表示查询`A`（Address）记录，即IPv4地址；
	- `2`表示查询`NS`记录，即域名服务器地址；
	- `5`表示查询`CNAME`记录；
	- `15`表示查询`MX`地址，即邮件发送交互地址；
	- `16`表示查询`TEXT`文本信息；
	- `28`表示查询`AAAA`记录，即IPv6地址；
- CLASS: 通常为`1`，表示TCP/IP互联网地址；
NAME部分的保存格式为以域名中的`.`为间隔，保存字符数和字符，例如: `www.baidu.com`会保存为`[0x03][w][w][w][0x05][b][a][i][d][u][0x03][c][o][m][0x00]`其中`[]`表示1字节，所以，每一级域名的长度理论上最大支持255个字符。

### 回复
